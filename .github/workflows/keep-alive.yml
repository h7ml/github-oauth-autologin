name: è‡ªåŠ¨ç™»å½•ä¿æ´»ï¼ˆé€šç”¨æ¡†æ¶ï¼‰

on:
  schedule:
    - cron: '0 7 */5 * *'  # UTC 7:00ï¼Œæ¯5å¤©è¿è¡Œ
  workflow_dispatch:
    inputs:
      site:
        description: 'ç«™ç‚¹åç§°ï¼ˆé»˜è®¤ clawcloudï¼‰'
        required: false
        default: 'clawcloud'

jobs:
  auto-login:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ç¼“å­˜ Playwright æµè§ˆå™¨
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
        id: check-secrets
        run: |
          if [[ -z "${{ secrets.GH_USERNAME }}" ]] || [[ -z "${{ secrets.GH_PASSWORD }}" ]]; then
            echo "âš ï¸  ç¼ºå°‘å¿…éœ€çš„ Secrets: GH_USERNAME æˆ– GH_PASSWORD"
            echo "ğŸ“ è¯·åœ¨ä»“åº“ Settings -> Secrets ä¸­é…ç½®è¿™äº›å˜é‡"
            echo "configured=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "âœ… å¿…éœ€çš„ Secrets å·²é…ç½®"
          echo "configured=true" >> $GITHUB_OUTPUT

      - name: å®‰è£…ä¾èµ–
        if: steps.check-secrets.outputs.configured == 'true'
        run: |
          pip install -r requirements.txt

      - name: å®‰è£… Playwright æµè§ˆå™¨
        if: steps.check-secrets.outputs.configured == 'true'
        run: |
          # Ubuntu 24.04 å…¼å®¹æ€§ä¿®å¤ï¼šlibasound2 å·²æ›´åä¸º libasound2t64
          sudo apt-get update
          sudo apt-get install -y libasound2t64 || sudo apt-get install -y libasound2
          playwright install chromium --with-deps

      - name: è¿è¡Œè‡ªåŠ¨ç™»å½•ï¼ˆé€šç”¨æ¡†æ¶ï¼‰
        if: steps.check-secrets.outputs.configured == 'true'
        env:
          GH_USERNAME: ${{ secrets.GH_USERNAME }}
          GH_PASSWORD: ${{ secrets.GH_PASSWORD }}
          GH_SESSION: ${{ secrets.GH_SESSION }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: python main.py ${{ github.event.inputs.site || 'clawcloud' }}

      - name: ä¸Šä¼ æˆªå›¾ï¼ˆå¤±è´¥æ—¶ï¼‰
        if: failure() && steps.check-secrets.outputs.configured == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: '*.png'
          retention-days: 7