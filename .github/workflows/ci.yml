name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ä»£ç æ ¼å¼æ£€æŸ¥ï¼ˆBlackï¼‰
        run: |
          black --check core/ utils/ sites/ notifiers/ tests/
        continue-on-error: false

      - name: Pylint æ£€æŸ¥
        run: |
          pylint core/ utils/ sites/ notifiers/ --exit-zero --output-format=colorized
        continue-on-error: true

      - name: ç±»å‹æ£€æŸ¥ï¼ˆMypyï¼‰
        run: |
          mypy core/ utils/ --ignore-missing-imports
        continue-on-error: true

  # å•å…ƒæµ‹è¯•
  test:
    name: Unit Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.11', '3.12']

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: è¿è¡Œæµ‹è¯•
        run: |
          pytest -v --cov=core --cov=utils --cov=sites --cov=notifiers \
                 --cov-report=xml --cov-report=term-missing

      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # å®‰å…¨æ£€æŸ¥
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install bandit safety

      - name: Bandit å®‰å…¨æ‰«æ
        run: |
          bandit -r core/ utils/ sites/ notifiers/ -f json -o bandit-report.json || true
          bandit -r core/ utils/ sites/ notifiers/ -f screen
        continue-on-error: true

      - name: Safety ä¾èµ–æ£€æŸ¥
        run: |
          safety check --json || true
        continue-on-error: true

      - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
          retention-days: 30

  # æ„å»ºæ£€æŸ¥
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [quality, test]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium --with-deps

      - name: éªŒè¯é…ç½®æ–‡ä»¶
        run: |
          python -c "import yaml; yaml.safe_load(open('config/sites.yaml'))"

      - name: å¯¼å…¥æ£€æŸ¥
        run: |
          python -c "from core.github_auth import GitHubAuthenticator"
          python -c "from core.cookie_manager import CookieManager"
          python -c "from core.state_manager import StateManager"
          python -c "from utils.logger import setup_logger"
          python -c "from utils.retry import retry_network"
          python -c "from utils.security import mask_sensitive"

      - name: é™æ€åˆ†æ
        run: |
          python -m py_compile core/*.py utils/*.py sites/*.py notifiers/*.py

  # æ–‡æ¡£æ£€æŸ¥
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯æ–‡æ¡£æ–‡ä»¶
        run: |
          test -f README.md
          test -f README_OPTIMIZATION.md
          test -f docs/index.html
          test -f CLAUDE.md
          test -f CHANGELOG.md

      - name: æ£€æŸ¥æ–‡æ¡£é“¾æ¥
        run: |
          # æ£€æŸ¥ Markdown æ–‡ä»¶ä¸­çš„é“¾æ¥ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
          grep -r "\[.*\](.*)" *.md || true

  # ä»£ç è¦†ç›–ç‡å¾½ç« æ›´æ–°
  coverage-badge:
    name: Update Coverage Badge
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install coverage-badge

      - name: ç”Ÿæˆè¦†ç›–ç‡
        run: |
          pytest --cov=core --cov=utils --cov=sites --cov=notifiers --cov-report=xml

      - name: ç”Ÿæˆå¾½ç« 
        run: |
          coverage-badge -o coverage.svg -f
        continue-on-error: true

  # é›†æˆæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium --with-deps

      - name: æ¨¡æ‹Ÿè¿è¡Œï¼ˆéªŒè¯å¯¼å…¥ï¼‰
        run: |
          python -c "
          from core.types import GitHubCredentials, SiteConfig
          from core.github_auth import GitHubAuthenticator
          from notifiers.telegram import TelegramNotifier
          from core.state_manager import StateManager
          
          # éªŒè¯çŠ¶æ€ç®¡ç†å™¨
          state = StateManager('.test_state.json')
          state.record_login_attempt('test', True)
          assert state.is_healthy('test')
          print('âœ… é›†æˆæµ‹è¯•é€šè¿‡')
          "

      - name: æ¸…ç†æµ‹è¯•æ–‡ä»¶
        run: |
          rm -f .test_state.json

  # æ€§èƒ½æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-benchmark

      - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
        run: |
          python -c "
          import time
          from utils.security import mask_sensitive
          from core.state_manager import StateManager
          
          # æ€§èƒ½æµ‹è¯•ï¼šæ•æ„Ÿä¿¡æ¯é®è”½
          start = time.perf_counter()
          for _ in range(10000):
              mask_sensitive('abcdefghijklmnopqrstuvwxyz', 4)
          duration = time.perf_counter() - start
          print(f'mask_sensitive: {duration:.4f}s for 10k iterations')
          assert duration < 1.0, 'Performance regression detected'
          
          # æ€§èƒ½æµ‹è¯•ï¼šçŠ¶æ€ç®¡ç†
          state = StateManager('.perf_test.json')
          start = time.perf_counter()
          for i in range(100):
              state.record_login_attempt(f'site_{i}', True)
          state.save()
          duration = time.perf_counter() - start
          print(f'StateManager: {duration:.4f}s for 100 records')
          assert duration < 0.5, 'Performance regression detected'
          "

      - name: æ¸…ç†
        run: rm -f .perf_test.json

  # æ±‡æ€»æŠ¥å‘Š
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [quality, test, security, build, docs]
    if: always()

    steps:
      - name: æ£€æŸ¥çŠ¶æ€
        run: |
          echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Code Quality: ${{ needs.quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Unit Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Security Scan: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build Check: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Documentation: ${{ needs.docs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.quality.result }}" == "success" && \
                "${{ needs.test.result }}" == "success" && \
                "${{ needs.build.result }}" == "success" ]]; then
            echo "ğŸ‰ **All checks passed!**" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "âŒ **Some checks failed. Please review the logs.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

